#import global_variables

function list_dependencies() {
    local file=$1
    local dependencies=$(grep ^#import $file | sed -e 's/^#import //' | tr -d ' ')

    for dependency in $dependencies
    do
	    echo "$file $dependency" >> $_build_temp_file
      
        list_dependencies $dependency
    done
}

function order_files() {
    local files=$(tsort < $_build_temp_file | tac)
    
    echo "$files"
}

function minify_script() { 
    sed -e '/^#import/d' $_output_file -e '/^#file=/d' -e '/^$/d' | cat > ${_build_temp_file} 
    mv ${_build_temp_file} ${_output_file}
}

function generate_script() {
    local start_file=$1

    list_dependencies $start_file

    local files=$(order_files)

    echo '' > $_output_file

    for file in $files
    do
        echo "#file=$file" >> $_output_file
        cat $file >> $_output_file
    done 

    if ! $_with_symbols ; then
        minify_script
    fi
}

function build() {
    local start_file=$1
    local name=1

    for i in $*
    do 
        name=$(($name + 1))
        case $i in
            --with-symbols )
                _with_symbols=true
            ;;

            --output | -o )
                _output_file=$(eval "echo \$${name}")
            ;;
        esac
    done

    generate_script $start_file 
}




